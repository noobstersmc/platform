apiVersion: v1
kind: Namespace
metadata:
  name: minecraft
---
apiVersion: v1
kind: Secret
metadata:
  name: velocity-forwarding-secret
  namespace: minecraft
type: Opaque
stringData:
  forwarding.secret: noobstersmc-forwarding-secret-2026
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: velocity-config-1
  namespace: minecraft
data:
  velocity.toml: |
    config-version = "2.7"
    bind = "0.0.0.0:25577"
    motd = "Velocity proxy-1"
    show-max-players = 500
    online-mode = true
    force-key-authentication = false
    player-info-forwarding-mode = "modern"
    forwarding-secret-file = "/etc/velocity-secret/forwarding.secret"
    announce-forge = false
    kick-existing-players = false
    ping-passthrough = "disabled"
    enable-player-address-logging = true

    [servers]
    limbo = "paper-limbo:25565"
    try = ["limbo"]

    [forced-hosts]
    "lobby.example.com" = ["limbo"]
    "factions.example.com" = ["limbo"]
    "minigames.example.com" = ["limbo"]
    "limbo.local" = ["limbo"]

    [advanced]
    compression-threshold = 256
    compression-level = -1
    login-ratelimit = 3000
    connection-timeout = 5000
    read-timeout = 30000
    haproxy-protocol = true
    tcp-fast-open = false
    bungee-plugin-message-channel = true
    show-ping-requests = false
    failover-on-unexpected-server-disconnect = true
    announce-proxy-commands = true
    log-command-executions = false
    log-player-connections = true
    accepts-transfers = true
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: velocity-config-2
  namespace: minecraft
data:
  velocity.toml: |
    config-version = "2.7"
    bind = "0.0.0.0:25577"
    motd = "Velocity proxy-2"
    show-max-players = 500
    online-mode = true
    force-key-authentication = false
    player-info-forwarding-mode = "modern"
    forwarding-secret-file = "/etc/velocity-secret/forwarding.secret"
    announce-forge = false
    kick-existing-players = false
    ping-passthrough = "disabled"
    enable-player-address-logging = true

    [servers]
    limbo = "paper-limbo:25565"
    try = ["limbo"]

    [forced-hosts]
    "lobby.example.com" = ["limbo"]
    "factions.example.com" = ["limbo"]
    "minigames.example.com" = ["limbo"]
    "limbo.local" = ["limbo"]

    [advanced]
    compression-threshold = 256
    compression-level = -1
    login-ratelimit = 3000
    connection-timeout = 5000
    read-timeout = 30000
    haproxy-protocol = true
    tcp-fast-open = false
    bungee-plugin-message-channel = true
    show-ping-requests = false
    failover-on-unexpected-server-disconnect = true
    announce-proxy-commands = true
    log-command-executions = false
    log-player-connections = true
    accepts-transfers = true
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: velocity-config-3
  namespace: minecraft
data:
  velocity.toml: |
    config-version = "2.7"
    bind = "0.0.0.0:25577"
    motd = "Velocity __POD_NAME__"
    show-max-players = 500
    online-mode = true
    force-key-authentication = false
    player-info-forwarding-mode = "modern"
    forwarding-secret-file = "/etc/velocity-secret/forwarding.secret"
    announce-forge = false
    kick-existing-players = false
    ping-passthrough = "disabled"
    enable-player-address-logging = true

    [servers]
    limbo = "paper-limbo:25565"
    try = ["limbo"]

    [forced-hosts]
    "lobby.example.com" = ["limbo"]
    "factions.example.com" = ["limbo"]
    "minigames.example.com" = ["limbo"]
    "limbo.local" = ["limbo"]

    [advanced]
    compression-threshold = 256
    compression-level = -1
    login-ratelimit = 3000
    connection-timeout = 5000
    read-timeout = 30000
    haproxy-protocol = true
    tcp-fast-open = false
    bungee-plugin-message-channel = true
    show-ping-requests = false
    failover-on-unexpected-server-disconnect = true
    announce-proxy-commands = true
    log-command-executions = false
    log-player-connections = true
    accepts-transfers = true
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: paper-proxy-config
  namespace: minecraft
data:
  paper-global.yml: |
    _version: 29
    proxies:
      velocity:
        enabled: true
        online-mode: true
        secret: "noobstersmc-forwarding-secret-2026"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: proxyops-runtime
  namespace: minecraft
data:
  defaultServer: lobby
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: velocity-1
  namespace: minecraft
spec:
  replicas: 0
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: velocity
      proxy-id: "1"
  template:
    metadata:
      labels:
        app: velocity
        proxy-id: "1"
    spec:
      terminationGracePeriodSeconds: 120
      initContainers:
      - name: install-transfer-plugins
        image: curlimages/curl:8.12.1
        envFrom:
        - secretRef:
            name: luckperms-db
        - secretRef:
            name: redisbungee-redis
        command:
        - /bin/sh
        - -ec
        - |
          mkdir -p /work/plugins/velocityrcon
          mkdir -p /work/plugins/luckperms
          cp /patched/ProxyTransfer-1.0.jar /work/plugins/ProxyTransfer-1.0.jar
          curl -fsSL -o /work/plugins/LuckPerms-Velocity-5.5.17.jar "https://cdn.modrinth.com/data/Vebnzrzj/versions/GZjsuCmU/LuckPerms-Velocity-5.5.17.jar"
          curl -fsSL -o /work/plugins/Tribufu-VelocityRcon-1.2.0.jar "https://mvn.tribufu.com/releases/com/tribufu/Tribufu-VelocityRcon/1.2.0/Tribufu-VelocityRcon-1.2.0.jar"
          cat > /work/plugins/luckperms/config.yml <<LPCONF
          storage-method: postgresql
          data:
            address: luckperms-postgres.minecraft.svc.cluster.local:5432
            database: ${POSTGRES_DB}
            username: ${POSTGRES_USER}
            password: ${POSTGRES_PASSWORD}
          LPCONF
          cat > /work/plugins/velocityrcon/rcon.toml <<'RCONF'
          rcon-host = "0.0.0.0"
          rcon-port = "25575"
          rcon-password = "noobstersmc-rcon-password-2026"
          rcon-colored = false
          RCONF
        volumeMounts:
        - name: velocity-plugin-bootstrap
          mountPath: /work/plugins
        - name: proxytransfer-patched
          mountPath: /patched
      containers:
      - name: velocity
        image: itzg/mc-proxy:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 25577
          name: minecraft
        - containerPort: 25578
          name: proxy0
        - containerPort: 25579
          name: proxy1
        - containerPort: 25580
          name: proxy2
        env:
        - name: TYPE
          value: VELOCITY
        - name: RCON_PASSWORD
          value: "noobstersmc-rcon-password-2026"
        - name: TRANSFER_TARGET
          value: "192.168.4.33:25577"
        volumeMounts:
        - name: velocity-plugin-bootstrap
          mountPath: /plugins
        - name: velocity-config
          mountPath: /config/velocity.toml
          subPath: velocity.toml
        - name: forwarding-secret
          mountPath: /etc/velocity-secret/forwarding.secret
          subPath: forwarding.secret
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/bash
              - -ec
              - |
                SELF_ORDINAL="${HOSTNAME##*-}"
                TARGET_HOST="${PROXY_TARGET_HOST:-192.168.4.33}"
                case "${SELF_ORDINAL}" in
                  0) TARGET_PORT=25579 ;;
                  1) TARGET_PORT=25580 ;;
                  2) TARGET_PORT=25578 ;;
                  *) TARGET_PORT=25577 ;;
                esac
                touch /tmp/draining
                sleep 10
                rcon-cli --host 127.0.0.1 --port 25575 --password "${RCON_PASSWORD}" "draintransfer ${TARGET_HOST}:${TARGET_PORT} all 3" || true
                sleep 8
                rcon-cli --host 127.0.0.1 --port 25575 --password "${RCON_PASSWORD}" "transfer ${TARGET_HOST}:${TARGET_PORT} all" || true
                sleep 30
        readinessProbe:
          exec:
            command:
            - /bin/bash
            - -ec
            - |
              test ! -f /tmp/draining
              exec 3<>/dev/tcp/127.0.0.1/25577
              exec 3<&-
              exec 3>&-
          initialDelaySeconds: 10
          periodSeconds: 5
        livenessProbe:
          tcpSocket:
            port: minecraft
          initialDelaySeconds: 30
          periodSeconds: 20
      volumes:
      - name: velocity-plugin-bootstrap
        emptyDir: {}
      - name: proxytransfer-patched
        configMap:
          name: proxytransfer-patched
      - name: velocity-config
        configMap:
          name: velocity-config-1
      - name: forwarding-secret
        secret:
          secretName: velocity-forwarding-secret
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: velocity-2
  namespace: minecraft
spec:
  replicas: 0
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: velocity
      proxy-id: "2"
  template:
    metadata:
      labels:
        app: velocity
        proxy-id: "2"
    spec:
      terminationGracePeriodSeconds: 120
      initContainers:
      - name: install-transfer-plugins
        image: curlimages/curl:8.12.1
        envFrom:
        - secretRef:
            name: luckperms-db
        - secretRef:
            name: redisbungee-redis
        command:
        - /bin/sh
        - -ec
        - |
          mkdir -p /work/plugins/velocityrcon
          mkdir -p /work/plugins/luckperms
          cp /patched/ProxyTransfer-1.0.jar /work/plugins/ProxyTransfer-1.0.jar
          curl -fsSL -o /work/plugins/LuckPerms-Velocity-5.5.17.jar "https://cdn.modrinth.com/data/Vebnzrzj/versions/GZjsuCmU/LuckPerms-Velocity-5.5.17.jar"
          curl -fsSL -o /work/plugins/Tribufu-VelocityRcon-1.2.0.jar "https://mvn.tribufu.com/releases/com/tribufu/Tribufu-VelocityRcon/1.2.0/Tribufu-VelocityRcon-1.2.0.jar"
          cat > /work/plugins/luckperms/config.yml <<LPCONF
          storage-method: postgresql
          data:
            address: luckperms-postgres.minecraft.svc.cluster.local:5432
            database: ${POSTGRES_DB}
            username: ${POSTGRES_USER}
            password: ${POSTGRES_PASSWORD}
          LPCONF
          cat > /work/plugins/velocityrcon/rcon.toml <<'RCONF'
          rcon-host = "0.0.0.0"
          rcon-port = "25575"
          rcon-password = "noobstersmc-rcon-password-2026"
          rcon-colored = false
          RCONF
        volumeMounts:
        - name: velocity-plugin-bootstrap
          mountPath: /work/plugins
        - name: proxytransfer-patched
          mountPath: /patched
      containers:
      - name: velocity
        image: itzg/mc-proxy:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 25577
          name: minecraft
        env:
        - name: TYPE
          value: VELOCITY
        - name: RCON_PASSWORD
          value: "noobstersmc-rcon-password-2026"
        - name: TRANSFER_TARGET
          value: "192.168.4.33:25577"
        volumeMounts:
        - name: velocity-plugin-bootstrap
          mountPath: /plugins
        - name: velocity-config
          mountPath: /config/velocity.toml
          subPath: velocity.toml
        - name: forwarding-secret
          mountPath: /etc/velocity-secret/forwarding.secret
          subPath: forwarding.secret
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/bash
              - -ec
              - |
                SELF_ORDINAL="${HOSTNAME##*-}"
                TARGET_HOST="${PROXY_TARGET_HOST:-192.168.4.33}"
                case "${SELF_ORDINAL}" in
                  0) TARGET_PORT=25579 ;;
                  1) TARGET_PORT=25580 ;;
                  2) TARGET_PORT=25578 ;;
                  *) TARGET_PORT=25577 ;;
                esac
                touch /tmp/draining
                sleep 10
                rcon-cli --host 127.0.0.1 --port 25575 --password "${RCON_PASSWORD}" "draintransfer ${TARGET_HOST}:${TARGET_PORT} all 3" || true
                sleep 8
                rcon-cli --host 127.0.0.1 --port 25575 --password "${RCON_PASSWORD}" "transfer ${TARGET_HOST}:${TARGET_PORT} all" || true
                sleep 30
        readinessProbe:
          exec:
            command:
            - /bin/bash
            - -ec
            - |
              test ! -f /tmp/draining
              exec 3<>/dev/tcp/127.0.0.1/25577
              exec 3<&-
              exec 3>&-
          initialDelaySeconds: 10
          periodSeconds: 5
        livenessProbe:
          tcpSocket:
            port: minecraft
          initialDelaySeconds: 30
          periodSeconds: 20
      volumes:
      - name: velocity-plugin-bootstrap
        emptyDir: {}
      - name: proxytransfer-patched
        configMap:
          name: proxytransfer-patched
      - name: velocity-config
        configMap:
          name: velocity-config-2
      - name: forwarding-secret
        secret:
          secretName: velocity-forwarding-secret
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: velocity
  namespace: minecraft
spec:
  serviceName: velocity-headless
  podManagementPolicy: OrderedReady
  replicas: 3
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: velocity
      proxy-id: "3"
  template:
    metadata:
      labels:
        app: velocity
        proxy-id: "3"
    spec:
      serviceAccountName: velocity-proxy-sa
      terminationGracePeriodSeconds: 120
      initContainers:
      - name: install-transfer-plugins
        image: curlimages/curl:8.12.1
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        envFrom:
        - secretRef:
            name: luckperms-db
        - secretRef:
            name: redisbungee-redis
        command:
        - /bin/sh
        - -ec
        - |
          mkdir -p /work/plugins/velocityrcon
          mkdir -p /work/plugins/luckperms
          cp /patched/ProxyTransfer-1.0.jar /work/plugins/ProxyTransfer-1.0.jar
          cp /ops/ProxyOps.jar /work/plugins/ProxyOps.jar
          mkdir -p /work/plugins/redisbungee
          curl -fsSL -o /work/plugins/RedisBungee-Proxy-Velocity-0.12.5-all.jar "https://github.com/ProxioDev/ValioBungee/releases/download/0.12.5/RedisBungee-Proxy-Velocity-0.12.5-all.jar"
          curl -fsSL -o /work/plugins/LuckPerms-Velocity-5.5.17.jar "https://cdn.modrinth.com/data/Vebnzrzj/versions/GZjsuCmU/LuckPerms-Velocity-5.5.17.jar"
          curl -fsSL -o /work/plugins/Tribufu-VelocityRcon-1.2.0.jar "https://mvn.tribufu.com/releases/com/tribufu/Tribufu-VelocityRcon/1.2.0/Tribufu-VelocityRcon-1.2.0.jar"
          cat > /work/plugins/redisbungee/config.yml <<RBCONF
          config-version: 2
          redis-server: redis.minecraft.svc.cluster.local
          redis-port: 6379
          redis-password: "${REDIS_PASSWORD}"
          redis-username: ""
          network-id: "main"
          proxy-id: "proxy-1"
          max-redis-connections: 20
          useSSL: false
          cluster-mode-enabled: false
          kick-when-online: true
          reconnect-to-last-server: false
          handle-motd: true
          RBCONF
          cat > /work/plugins/luckperms/config.yml <<LPCONF
          storage-method: postgresql
          data:
            address: luckperms-postgres.minecraft.svc.cluster.local:5432
            database: ${POSTGRES_DB}
            username: ${POSTGRES_USER}
            password: ${POSTGRES_PASSWORD}
          LPCONF
          cat > /work/plugins/velocityrcon/rcon.toml <<'RCONF'
          rcon-host = "0.0.0.0"
          rcon-port = "25575"
          rcon-password = "noobstersmc-rcon-password-2026"
          rcon-colored = false
          RCONF
          cp /config-template/velocity.toml /work-config/velocity.toml
          sed -i "s/__POD_NAME__/${POD_NAME}/g" /work-config/velocity.toml
        volumeMounts:
        - name: velocity-plugin-bootstrap
          mountPath: /work/plugins
        - name: proxytransfer-patched
          mountPath: /patched
        - name: proxyops-plugin
          mountPath: /ops
        - name: velocity-config-template
          mountPath: /config-template
        - name: velocity-config-generated
          mountPath: /work-config
      containers:
      - name: velocity
        image: itzg/mc-proxy:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 25577
          name: minecraft
        env:
        - name: TYPE
          value: VELOCITY
        - name: RCON_PASSWORD
          value: "noobstersmc-rcon-password-2026"
        - name: TRANSFER_TARGET
          value: "192.168.4.33:25577"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: REDISBUNGEE_PROXY_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: REDISBUNGEE_NETWORK_ID
          value: "main"
        - name: PROXY_WORKLOAD
          value: "velocity"
        - name: PROXY_WORKLOAD_KIND
          value: "statefulset"
        - name: PROXY_PORT
          value: "25577"
        - name: PROXY_TRANSFER_HOST
          value: "192.168.4.33"
        - name: PROXY_TRANSFER_PORT
          value: "25577"
        - name: PROXY_TARGET_HOST
          value: "192.168.4.33"
        - name: PROXY_TARGET_BASE_PORT
          value: "25578"
        - name: PROXY_HAPROXY_PROTOCOL_REQUIRED
          value: "true"
        - name: PROXY_DISCOVERY_ENABLED
          value: "true"
        - name: PROXY_DISCOVERY_LABEL_KEY
          value: "mc.noobsters.net/velocity-discovery"
        - name: PROXY_DISCOVERY_LABEL_VALUE
          value: "enabled"
        - name: PROXY_DISCOVERY_NAME_PREFIX
          value: ""
        - name: PROXY_RUNTIME_CONFIGMAP
          value: "proxyops-runtime"
        - name: PROXY_DISCOVERY_INTERVAL_SECONDS
          value: "5"
        volumeMounts:
        - name: velocity-plugin-bootstrap
          mountPath: /plugins
        - name: velocity-config-generated
          mountPath: /config/velocity.toml
          subPath: velocity.toml
        - name: forwarding-secret
          mountPath: /etc/velocity-secret/forwarding.secret
          subPath: forwarding.secret
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/bash
              - -ec
              - |
                SELF_ORDINAL="${HOSTNAME##*-}"
                TARGET_HOST="${PROXY_TARGET_HOST:-192.168.4.33}"
                case "${SELF_ORDINAL}" in
                  0) TARGET_PORT=25579 ;;
                  1) TARGET_PORT=25580 ;;
                  2) TARGET_PORT=25578 ;;
                  *) TARGET_PORT=25577 ;;
                esac
                touch /tmp/draining
                sleep 10
                rcon-cli --host 127.0.0.1 --port 25575 --password "${RCON_PASSWORD}" "draintransfer ${TARGET_HOST}:${TARGET_PORT} all 3" || true
                sleep 8
                rcon-cli --host 127.0.0.1 --port 25575 --password "${RCON_PASSWORD}" "transfer ${TARGET_HOST}:${TARGET_PORT} all" || true
                sleep 30
        readinessProbe:
          exec:
            command:
            - /bin/bash
            - -ec
            - |
              test ! -f /tmp/draining
              exec 3<>/dev/tcp/127.0.0.1/25577
              exec 3<&-
              exec 3>&-
          initialDelaySeconds: 10
          periodSeconds: 5
        livenessProbe:
          tcpSocket:
            port: minecraft
          initialDelaySeconds: 30
          periodSeconds: 20
      volumes:
      - name: velocity-plugin-bootstrap
        emptyDir: {}
      - name: proxytransfer-patched
        configMap:
          name: proxytransfer-patched
      - name: proxyops-plugin
        configMap:
          name: proxyops-plugin
      - name: velocity-config-template
        configMap:
          name: velocity-config-3
      - name: velocity-config-generated
        emptyDir: {}
      - name: forwarding-secret
        secret:
          secretName: velocity-forwarding-secret
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: velocity-lb-config
  namespace: minecraft
data:
  haproxy.cfg: |
    global
      maxconn 2048
      log stdout format raw local0

    defaults
      mode tcp
      timeout connect 5s
      timeout client 1m
      timeout server 1m
      option tcplog

    frontend minecraft_in
      bind *:25577
      default_backend velocity_backends

    frontend proxy0_in
      bind *:25578
      default_backend velocity_0

    frontend proxy1_in
      bind *:25579
      default_backend velocity_1

    frontend proxy2_in
      bind *:25580
      default_backend velocity_2

    backend velocity_backends
      balance roundrobin
      server proxy0 velocity-0-svc.minecraft.svc.cluster.local:25577 send-proxy
      server proxy1 velocity-1-svc.minecraft.svc.cluster.local:25577 send-proxy
      server proxy2 velocity-2-svc.minecraft.svc.cluster.local:25577 send-proxy

    backend velocity_0
      server proxy0 velocity-0-svc.minecraft.svc.cluster.local:25577 send-proxy

    backend velocity_1
      server proxy1 velocity-1-svc.minecraft.svc.cluster.local:25577 send-proxy

    backend velocity_2
      server proxy2 velocity-2-svc.minecraft.svc.cluster.local:25577 send-proxy
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: velocity-lb
  namespace: minecraft
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: velocity-lb
  template:
    metadata:
      labels:
        app: velocity-lb
    spec:
      terminationGracePeriodSeconds: 30
      containers:
      - name: haproxy
        image: haproxy:2.9-alpine
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 25577
          name: minecraft
        - containerPort: 25578
          name: proxy0
        - containerPort: 25579
          name: proxy1
        - containerPort: 25580
          name: proxy2
        volumeMounts:
        - name: config
          mountPath: /usr/local/etc/haproxy/haproxy.cfg
          subPath: haproxy.cfg
        readinessProbe:
          tcpSocket:
            port: minecraft
          initialDelaySeconds: 5
          periodSeconds: 5
        livenessProbe:
          tcpSocket:
            port: minecraft
          initialDelaySeconds: 15
          periodSeconds: 10
      volumes:
      - name: config
        configMap:
          name: velocity-lb-config
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: velocity-proxies-pdb
  namespace: minecraft
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: velocity
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: velocity-lb-pdb
  namespace: minecraft
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: velocity-lb
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: velocity-proxy-sa
  namespace: minecraft
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: velocity-proxy-ops
  namespace: minecraft
rules:
- apiGroups: [""]
  resources: ["pods", "services", "endpoints"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "patch"]
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets"]
  verbs: ["get", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: velocity-proxy-ops
  namespace: minecraft
subjects:
- kind: ServiceAccount
  name: velocity-proxy-sa
  namespace: minecraft
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: velocity-proxy-ops
---
apiVersion: v1
kind: Service
metadata:
  name: velocity-headless
  namespace: minecraft
spec:
  clusterIP: None
  selector:
    app: velocity
    proxy-id: "3"
  ports:
  - name: minecraft
    port: 25577
    targetPort: minecraft
---
apiVersion: v1
kind: Service
metadata:
  name: velocity-0-svc
  namespace: minecraft
spec:
  selector:
    statefulset.kubernetes.io/pod-name: velocity-0
  ports:
  - name: minecraft
    port: 25577
    targetPort: minecraft
---
apiVersion: v1
kind: Service
metadata:
  name: velocity-1-svc
  namespace: minecraft
spec:
  selector:
    statefulset.kubernetes.io/pod-name: velocity-1
  ports:
  - name: minecraft
    port: 25577
    targetPort: minecraft
---
apiVersion: v1
kind: Service
metadata:
  name: velocity-2-svc
  namespace: minecraft
spec:
  selector:
    statefulset.kubernetes.io/pod-name: velocity-2
  ports:
  - name: minecraft
    port: 25577
    targetPort: minecraft
---
apiVersion: v1
kind: Service
metadata:
  name: velocity-proxy
  namespace: minecraft
spec:
  type: NodePort
  selector:
    app: velocity-lb
  ports:
  - name: minecraft
    port: 25577
    targetPort: minecraft
    nodePort: 31577
  - name: proxy0
    port: 25578
    targetPort: 25578
    nodePort: 31578
  - name: proxy1
    port: 25579
    targetPort: 25579
    nodePort: 31579
  - name: proxy2
    port: 25580
    targetPort: 25580
    nodePort: 31580
---
apiVersion: v1
kind: Service
metadata:
  name: velocity-proxy-1
  namespace: minecraft
spec:
  type: ClusterIP
  selector:
    app: velocity
    proxy-id: "1"
  ports:
  - name: minecraft
    port: 25577
    targetPort: minecraft
---
apiVersion: v1
kind: Service
metadata:
  name: velocity-proxy-2
  namespace: minecraft
spec:
  type: ClusterIP
  selector:
    app: velocity
    proxy-id: "2"
  ports:
  - name: minecraft
    port: 25577
    targetPort: minecraft
---
apiVersion: v1
kind: Service
metadata:
  name: velocity-proxy-3
  namespace: minecraft
spec:
  type: ClusterIP
  selector:
    app: velocity
    proxy-id: "3"
  ports:
  - name: minecraft
    port: 25577
    targetPort: minecraft
---
apiVersion: v1
kind: Secret
metadata:
  name: redisbungee-redis
  namespace: minecraft
type: Opaque
stringData:
  REDIS_PASSWORD: redisbungee-strong-password-2026
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: minecraft
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        imagePullPolicy: IfNotPresent
        envFrom:
        - secretRef:
            name: redisbungee-redis
        command:
        - sh
        - -ec
        - |
          exec redis-server --appendonly yes --requirepass "$REDIS_PASSWORD"
        ports:
        - containerPort: 6379
          name: redis
        readinessProbe:
          exec:
            command:
            - sh
            - -ec
            - redis-cli -a "$REDIS_PASSWORD" ping | grep -q PONG
          initialDelaySeconds: 5
          periodSeconds: 5
        livenessProbe:
          exec:
            command:
            - sh
            - -ec
            - redis-cli -a "$REDIS_PASSWORD" ping | grep -q PONG
          initialDelaySeconds: 20
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: minecraft
spec:
  selector:
    app: redis
  ports:
  - name: redis
    port: 6379
    targetPort: redis
---
apiVersion: v1
kind: Secret
metadata:
  name: luckperms-db
  namespace: minecraft
type: Opaque
stringData:
  POSTGRES_DB: luckperms
  POSTGRES_USER: luckperms
  POSTGRES_PASSWORD: luckperms-strong-password-2026
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: luckperms-postgres-data
  namespace: minecraft
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: luckperms-postgres
  namespace: minecraft
spec:
  replicas: 1
  selector:
    matchLabels:
      app: luckperms-postgres
  template:
    metadata:
      labels:
        app: luckperms-postgres
    spec:
      containers:
      - name: postgres
        image: postgres:16-alpine
        imagePullPolicy: IfNotPresent
        envFrom:
        - secretRef:
            name: luckperms-db
        ports:
        - containerPort: 5432
          name: postgres
        readinessProbe:
          exec:
            command:
            - sh
            - -ec
            - pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB"
          initialDelaySeconds: 5
          periodSeconds: 5
        livenessProbe:
          exec:
            command:
            - sh
            - -ec
            - pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB"
          initialDelaySeconds: 20
          periodSeconds: 10
        volumeMounts:
        - name: db-data
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: db-data
        persistentVolumeClaim:
          claimName: luckperms-postgres-data
---
apiVersion: v1
kind: Service
metadata:
  name: luckperms-postgres
  namespace: minecraft
spec:
  selector:
    app: luckperms-postgres
  ports:
  - name: postgres
    port: 5432
    targetPort: postgres
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: paper-lobby-data
  namespace: minecraft
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: paper-survival-data
  namespace: minecraft
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: paper-creative-data
  namespace: minecraft
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: paper-lobby
  namespace: minecraft
spec:
  serviceName: paper-lobby
  podManagementPolicy: OrderedReady
  replicas: 2
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: paper-lobby
  template:
    metadata:
      labels:
        app: paper-lobby
    spec:
      initContainers:
      - name: configure-luckperms
        image: bash:5.2
        envFrom:
        - secretRef:
            name: luckperms-db
        command:
        - /usr/local/bin/bash
        - -ec
        - |
          mkdir -p /data/plugins/LuckPerms
          cat > /data/plugins/LuckPerms/config.yml <<LPCONF
          storage-method: postgresql
          data:
            address: luckperms-postgres.minecraft.svc.cluster.local:5432
            database: ${POSTGRES_DB}
            username: ${POSTGRES_USER}
            password: ${POSTGRES_PASSWORD}
          LPCONF
        volumeMounts:
        - name: paper-data
          mountPath: /data
      containers:
      - name: minecraft
        image: itzg/minecraft-server:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 25565
          name: minecraft
        env:
        - name: EULA
          value: "TRUE"
        - name: TYPE
          value: PAPER
        - name: VERSION
          value: "1.21.4"
        - name: ONLINE_MODE
          value: "FALSE"
        - name: ACCEPTS_TRANSFERS
          value: "TRUE"
        - name: MEMORY
          value: 1G
        - name: MOTD
          value: "Lobby Server"
        - name: SPIGET_RESOURCES
          value: "28140"
        - name: ENABLE_RCON
          value: "true"
        - name: RCON_PASSWORD
          value: "paper-rcon-password-2026"
        volumeMounts:
        - name: paper-data
          mountPath: /data
        - name: paper-proxy-config
          mountPath: /config/paper-global.yml
          subPath: paper-global.yml
        readinessProbe:
          tcpSocket:
            port: minecraft
          initialDelaySeconds: 20
          periodSeconds: 10
        livenessProbe:
          tcpSocket:
            port: minecraft
          initialDelaySeconds: 180
          periodSeconds: 20
      volumes:
      - name: paper-proxy-config
        configMap:
          name: paper-proxy-config
  volumeClaimTemplates:
  - metadata:
      name: paper-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 10Gi
---
apiVersion: v1
kind: Service
metadata:
  name: paper-lobby
  namespace: minecraft
spec:
  selector:
    app: paper-lobby
  ports:
  - name: minecraft
    port: 25565
    targetPort: minecraft
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: paper-survival
  namespace: minecraft
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: paper-survival
  template:
    metadata:
      labels:
        app: paper-survival
    spec:
      initContainers:
      - name: configure-luckperms
        image: bash:5.2
        envFrom:
        - secretRef:
            name: luckperms-db
        command:
        - /usr/local/bin/bash
        - -ec
        - |
          mkdir -p /data/plugins/LuckPerms
          cat > /data/plugins/LuckPerms/config.yml <<LPCONF
          storage-method: postgresql
          data:
            address: luckperms-postgres.minecraft.svc.cluster.local:5432
            database: ${POSTGRES_DB}
            username: ${POSTGRES_USER}
            password: ${POSTGRES_PASSWORD}
          LPCONF
        volumeMounts:
        - name: paper-data
          mountPath: /data
      containers:
      - name: minecraft
        image: itzg/minecraft-server:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 25565
          name: minecraft
        env:
        - name: EULA
          value: "TRUE"
        - name: TYPE
          value: PAPER
        - name: VERSION
          value: "1.21.4"
        - name: ONLINE_MODE
          value: "FALSE"
        - name: ACCEPTS_TRANSFERS
          value: "TRUE"
        - name: MEMORY
          value: 1G
        - name: MOTD
          value: "Survival Server"
        - name: SPIGET_RESOURCES
          value: "28140"
        - name: ENABLE_RCON
          value: "true"
        - name: RCON_PASSWORD
          value: "paper-rcon-password-2026"
        volumeMounts:
        - name: paper-data
          mountPath: /data
        - name: paper-proxy-config
          mountPath: /config/paper-global.yml
          subPath: paper-global.yml
        readinessProbe:
          tcpSocket:
            port: minecraft
          initialDelaySeconds: 20
          periodSeconds: 10
        livenessProbe:
          tcpSocket:
            port: minecraft
          initialDelaySeconds: 180
          periodSeconds: 20
      volumes:
      - name: paper-data
        persistentVolumeClaim:
          claimName: paper-survival-data
      - name: paper-proxy-config
        configMap:
          name: paper-proxy-config
---
apiVersion: v1
kind: Service
metadata:
  name: paper-lobby-0
  namespace: minecraft
  labels:
    mc.noobsters.net/velocity-discovery: "enabled"
  annotations:
    mc.noobsters.net/velocity-server-name: lobby
spec:
  selector:
    statefulset.kubernetes.io/pod-name: paper-lobby-0
  ports:
  - name: minecraft
    port: 25565
    targetPort: minecraft
---
apiVersion: v1
kind: Service
metadata:
  name: paper-lobby-1
  namespace: minecraft
  labels:
    mc.noobsters.net/velocity-discovery: "enabled"
  annotations:
    mc.noobsters.net/velocity-server-name: lobby
spec:
  selector:
    statefulset.kubernetes.io/pod-name: paper-lobby-1
  ports:
  - name: minecraft
    port: 25565
    targetPort: minecraft
---
apiVersion: v1
kind: Service
metadata:
  name: paper-survival
  namespace: minecraft
  labels:
    mc.noobsters.net/velocity-discovery: "enabled"
  annotations:
    mc.noobsters.net/velocity-server-name: survival
spec:
  selector:
    app: paper-survival
  ports:
  - name: minecraft
    port: 25565
    targetPort: minecraft
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: paper-creative
  namespace: minecraft
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: paper-creative
  template:
    metadata:
      labels:
        app: paper-creative
    spec:
      initContainers:
      - name: configure-luckperms
        image: bash:5.2
        envFrom:
        - secretRef:
            name: luckperms-db
        command:
        - /usr/local/bin/bash
        - -ec
        - |
          mkdir -p /data/plugins/LuckPerms
          cat > /data/plugins/LuckPerms/config.yml <<LPCONF
          storage-method: postgresql
          data:
            address: luckperms-postgres.minecraft.svc.cluster.local:5432
            database: ${POSTGRES_DB}
            username: ${POSTGRES_USER}
            password: ${POSTGRES_PASSWORD}
          LPCONF
        volumeMounts:
        - name: paper-data
          mountPath: /data
      containers:
      - name: minecraft
        image: itzg/minecraft-server:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 25565
          name: minecraft
        env:
        - name: EULA
          value: "TRUE"
        - name: TYPE
          value: PAPER
        - name: VERSION
          value: "1.21.4"
        - name: ONLINE_MODE
          value: "FALSE"
        - name: ACCEPTS_TRANSFERS
          value: "TRUE"
        - name: MEMORY
          value: 1G
        - name: MOTD
          value: "Creative Server"
        - name: SPIGET_RESOURCES
          value: "28140"
        - name: ENABLE_RCON
          value: "true"
        - name: RCON_PASSWORD
          value: "paper-rcon-password-2026"
        volumeMounts:
        - name: paper-data
          mountPath: /data
        - name: paper-proxy-config
          mountPath: /config/paper-global.yml
          subPath: paper-global.yml
        readinessProbe:
          tcpSocket:
            port: minecraft
          initialDelaySeconds: 20
          periodSeconds: 10
        livenessProbe:
          tcpSocket:
            port: minecraft
          initialDelaySeconds: 180
          periodSeconds: 20
      volumes:
      - name: paper-data
        persistentVolumeClaim:
          claimName: paper-creative-data
      - name: paper-proxy-config
        configMap:
          name: paper-proxy-config
---
apiVersion: v1
kind: Service
metadata:
  name: paper-creative
  namespace: minecraft
  labels:
    mc.noobsters.net/velocity-discovery: "enabled"
  annotations:
    mc.noobsters.net/velocity-server-name: creative
spec:
  selector:
    app: paper-creative
  ports:
  - name: minecraft
    port: 25565
    targetPort: minecraft
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: paper-limbo
  namespace: minecraft
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: paper-limbo
  template:
    metadata:
      labels:
        app: paper-limbo
    spec:
      containers:
      - name: minecraft
        image: itzg/minecraft-server:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 25565
          name: minecraft
        env:
        - name: EULA
          value: "TRUE"
        - name: TYPE
          value: PAPER
        - name: VERSION
          value: "1.21.4"
        - name: ONLINE_MODE
          value: "FALSE"
        - name: ACCEPTS_TRANSFERS
          value: "TRUE"
        - name: MEMORY
          value: 768M
        - name: LEVEL_TYPE
          value: "FLAT"
        - name: GENERATOR_SETTINGS
          value: '{"layers":[],"biome":"minecraft:the_void","structures":{}}'
        - name: MODE
          value: spectator
        - name: DIFFICULTY
          value: peaceful
        - name: ALLOW_NETHER
          value: "false"
        - name: PVP
          value: "false"
        - name: SPAWN_MONSTERS
          value: "false"
        - name: SPAWN_ANIMALS
          value: "false"
        - name: SPAWN_NPCS
          value: "false"
        - name: VIEW_DISTANCE
          value: "2"
        - name: SIMULATION_DISTANCE
          value: "2"
        - name: MAX_PLAYERS
          value: "40"
        - name: MOTD
          value: "Limbo"
        volumeMounts:
        - name: paper-proxy-config
          mountPath: /config/paper-global.yml
          subPath: paper-global.yml
        readinessProbe:
          tcpSocket:
            port: minecraft
          initialDelaySeconds: 20
          periodSeconds: 10
        livenessProbe:
          tcpSocket:
            port: minecraft
          initialDelaySeconds: 120
          periodSeconds: 20
      volumes:
      - name: paper-proxy-config
        configMap:
          name: paper-proxy-config
---
apiVersion: v1
kind: Service
metadata:
  name: paper-limbo
  namespace: minecraft
spec:
  selector:
    app: paper-limbo
  ports:
  - name: minecraft
    port: 25565
    targetPort: minecraft
